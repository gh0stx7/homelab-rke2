apiVersion: apps/v1
kind: Deployment
metadata:
  name: media-stack
  namespace: media
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: media-stack
  template:
    metadata:
      labels:
        app: media-stack
    spec:
      containers:
        # --- 1. The Downloader (Sabnzbd) ---
        - name: sabnzbd
          image: lscr.io/linuxserver/sabnzbd:latest
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
          ports:
            - containerPort: 8080
              name: sab-web
          volumeMounts:
            - name: unified-storage
              mountPath: /config
              subPath: config/sabnzbd # Keeps config separate
            - name: unified-storage
              mountPath: /data
              subPath: media # The shared media folder

        # --- 2. The Manager (Sonarr) ---
        - name: sonarr
          image: lscr.io/linuxserver/sonarr:latest
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
          ports:
            - containerPort: 8989
              name: sonarr-web
          volumeMounts:
            - name: unified-storage
              mountPath: /config
              subPath: config/sonarr
            - name: unified-storage
              mountPath: /data
              subPath: media

        # --- 3. The Manager (Radarr) ---
        - name: radarr
          image: lscr.io/linuxserver/radarr:latest
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
          ports:
            - containerPort: 7878
              name: radarr-web
          volumeMounts:
            - name: unified-storage
              mountPath: /config
              subPath: config/radarr
            - name: unified-storage
              mountPath: /data
              subPath: media

        # --- 4. The Server (Jellyfin) ---
        - name: jellyfin
          image: jellyfin/jellyfin:latest
          ports:
            - containerPort: 8096
              name: jellyfin-web
          # Resource limits are important so Jellyfin doesn't starve the downloaders
          resources:
            requests:
              memory: "4Gi"
              cpu: "1000m"
              # If you have the Intel GPU plugin set up:
              # intel.com/gpu: "1"
          volumeMounts:
            - name: unified-storage
              mountPath: /config
              subPath: config/jellyfin
            - name: unified-storage
              mountPath: /data
              subPath: media

      # --- The Shared Volume ---
      volumes:
        - name: unified-storage
          persistentVolumeClaim:
            claimName: media-stack-pvc # Matches your Harvester PVC