apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sabnzbd-config
  annotations:
    helm.sh/resource-policy: keep
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn-2r
  resources: { requests: { storage: 10Gi } }
---
# --- Auto-Setup Script (Whitelist + Folders) ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sabnzbd-init-script
data:
  99-setup-stack.sh: |
    #!/bin/bash
    CONFIG="/config/sabnzbd.ini"
    HOSTNAMES="sabnzbd.lab.ghostlabz.net, sabnzbd, sabnzbd.media, sabnzbd.media.svc.cluster.local"
    
    echo "[custom-init] Starting SABnzbd Bootstrap..."

    # 1. Wait for SABnzbd to create the config file (first boot)
    COUNTER=0
    while [ ! -f "$CONFIG" ] && [ $COUNTER -lt 30 ]; do
    echo "[custom-init] Waiting for SABnzbd to create config file..."
    sleep 2
    COUNTER=$((COUNTER + 1))
    done

    if [ ! -f "$CONFIG" ]; then
    echo "[custom-init] ERROR: Config file not found after 60 seconds"
    exit 0  # Don't fail the container
    fi

    # 2. Ensure Folder Structure Exists
    if [ -d "/media/hot" ]; then
      echo "[custom-init] Creating directory structure on Hot Storage..."
      mkdir -p /media/hot/downloads/incomplete
      mkdir -p /media/hot/downloads/completed
      mkdir -p /media/hot/movies
      mkdir -p /media/hot/tv
      chmod -R 777 /media/hot/downloads
      chmod -R 777 /media/hot/movies
      chmod -R 777 /media/hot/tv
    fi

    # 3. Patch Host Whitelist
    echo "[custom-init] Patching Hostname Whitelist..."
    
    # Check if host_whitelist line exists
    if grep -q "^host_whitelist" "$CONFIG"; then
    # Line exists - check if our hostnames are already there
    if ! grep -q "ghostlabz.net" "$CONFIG"; then
      echo "[custom-init] Adding hostnames to existing whitelist..."
      # Append to existing line
      sed -i "s/^host_whitelist = .*/& , $HOSTNAMES/" "$CONFIG"
    else
      echo "[custom-init] Hostnames already in whitelist, skipping..."
    fi
    else
    # Line doesn't exist - add it
    echo "[custom-init] Creating new host_whitelist line..."
    # Add under [misc] section if it exists, otherwise append to end
    if grep -q "^\[misc\]" "$CONFIG"; then
      sed -i "/^\[misc\]/a host_whitelist = $HOSTNAMES" "$CONFIG"
    else
      echo -e "\n[misc]\nhost_whitelist = $HOSTNAMES" >> "$CONFIG"
    fi
    fi
    
    echo "[custom-init] Bootstrap Complete."
    echo "[custom-init] Final host_whitelist value:"
    grep "^host_whitelist" "$CONFIG" || echo "[custom-init] WARNING: host_whitelist not found!"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sabnzbd
  labels:
    app: sabnzbd
    stack: media-anchor
spec:
  replicas: 1
  strategy: { type: Recreate }
  selector:
    matchLabels: { app: sabnzbd }
  template:
    metadata:
      labels:
        app: sabnzbd
        stack: media-anchor
      annotations:
        backup.velero.io/backup-volumes-excludes: hot
    spec:
      containers:
        - name: sabnzbd
          image: lscr.io/linuxserver/sabnzbd:latest
          env:
            - { name: PUID, value: "1000" }
            - { name: PGID, value: "1000" }
            - { name: TZ, value: "America/New_York" }
          ports:
            - { containerPort: 8080, name: http }
          volumeMounts:
            - name: init-script
              mountPath: /custom-cont-init.d/99-setup-stack.sh
              subPath: 99-setup-stack.sh
            - { name: config, mountPath: /config }
            - { name: hot, mountPath: /media/hot }
            - { name: cold, mountPath: /media/cold }
          resources:
            requests:
              cpu: "2000m"
              memory: "2Gi"
      volumes:
        - name: init-script
          configMap:
            name: sabnzbd-init-script
            defaultMode: 0755
        - name: config
          persistentVolumeClaim: { claimName: sabnzbd-config }
        - name: hot
          persistentVolumeClaim: { claimName: media-hot-pvc } # Shared RWO
        - name: cold
          persistentVolumeClaim: { claimName: media-nfs-pvc } # Shared RWX