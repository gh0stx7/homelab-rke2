apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init-script
  namespace: unifi
data:
  init-mongo.sh: |
    #!/bin/bash
    set -e
    
    echo "Waiting for MongoDB to be ready..."
    until mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
      sleep 2
    done
    
    echo "Creating UniFi database and user..."
    mongosh <<EOF
    use admin
    db.auth('${MONGO_INITDB_ROOT_USERNAME}', '${MONGO_INITDB_ROOT_PASSWORD}')
    
    use ${MONGO_DBNAME}
    db.createUser({
      user: '${MONGO_USER}',
      pwd: '${MONGO_PASS}',
      roles: [
        { role: 'dbOwner', db: '${MONGO_DBNAME}' },
        { role: 'dbOwner', db: '${MONGO_DBNAME}_stat' }
      ]
    })
    EOF
    
    echo "MongoDB initialization complete"