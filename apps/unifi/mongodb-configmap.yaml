apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init-script
  namespace: unifi
data:
  init-mongo.sh: |
    #!/bin/bash
    set -e
    
    echo "MongoDB Init Script Starting..."
    
    # Wait for MongoDB to be ready
    echo "Waiting for MongoDB to be ready..."
    until mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
      echo "MongoDB not ready yet, waiting..."
      sleep 2
    done
    
    echo "MongoDB is ready. Creating unifi user..."
    
    # Create the user
    mongosh <<EOF
    use admin
    db.auth('${MONGO_INITDB_ROOT_USERNAME}', '${MONGO_INITDB_ROOT_PASSWORD}')
    
    use ${MONGO_DBNAME}
    
    // Check if user already exists
    var userExists = db.getUser('${MONGO_USER}')
    if (!userExists) {
      db.createUser({
        user: '${MONGO_USER}',
        pwd: '${MONGO_PASS}',
        roles: [
          { role: 'dbOwner', db: '${MONGO_DBNAME}' },
          { role: 'dbOwner', db: '${MONGO_DBNAME}_stat' }
        ]
      })
      print('User ${MONGO_USER} created successfully')
    } else {
      print('User ${MONGO_USER} already exists')
    }
    EOF
    
    echo "MongoDB initialization complete!"